<%- include('../partials/admin/admin-header.ejs') %>
<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Categories </h2>
            <p>Add, edit or delete a category</p>
        </div>
        <div>
            <input type="text" placeholder="Search Categories" class="form-control bg-white">
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <form method="post" action="/admin/category" onsubmit="return handleFormSubmit(event)">
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Name</label>
                            <input type="text" placeholder="Type here" class="form-control" id="product_name" />
                        </div>
                        <div class="mb-4">
                            <label for="product_slug" class="form-label">Slug</label>
                            <input type="text" placeholder="Type here" class="form-control" id="product_slug" />
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Parent</label>
                            <select class="form-select">
                                <option>Clothes</option>
                                <option>T-Shirts</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Description</label>
                            <textarea placeholder="Type here" class="form-control" id="description"></textarea>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary">Create category</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-9">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="text-center">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" />
                                        </div>
                                    </th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Slug</th>
                                    <th>Order</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% cat.reverse().forEach( (category,index)=>{ %>
                                <tr>
                                    <td class="text-center">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" />
                                        </div>
                                    </td>
                                    <td>21</td>
                                    <td><b><%= category.name %></b></td>
                                    <td><%= category.description %></td>
                                    <td>/men</td>
                                    <td>1</td>
                                    <td class="text-end">
                                        <div class="dropdown">
                                            <a href="#" data-bs-toggle="dropdown" class="btn btn-light rounded btn-sm font-sm"> <i class="material-icons md-more_horiz"></i> </a>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item" href="#">View detail</a>
                                                <a class="dropdown-item" href="#">Edit info</a>
                                                <a class="dropdown-item text-danger" href="#">Delete</a>
                                            </div>
                                        </div> <!-- dropdown //end -->
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div> <!-- .col// -->
            </div> <!-- .row // -->
        </div> <!-- card body .// -->
    </div> <!-- card .// -->
</section>
<%- include('../partials/admin/admin-footer.ejs') %>

<script>

    function handleFormSubmit(event){

        event.preventDefault();
        if(!validateForm()){
            return 
        }

        const name = document.getElementsByName('name')[0].value;
        const description = document.getElementById('description').value;

        fetch('/admin/addCategory',{
            method : 'POST',
            headers : {
                'content-type' : 'application-json',
            },
            body : JSON.stringify({name,description})
        })
        .then(response=>{
            if(response.ok){
                return response.json().then(error=>{
                    throw new Error(error.error);
                })
            }
            return response.json()
        })
        .then(data=>{
            location.reload()
        })
        .catch(error=>{
            if(error.message === 'Category alredy exists'){
                Swal.fire({
                    icon:'error',
                    title : 'Oops',
                    text : 'Category alredy exists',
                })
            }else{
                Swal.fire({
                    icon : "error",
                    title : "Oops",
                    text : "An error occured while adding the category",
                })
            }
        })
    }

    function validateForm(){
        clearErrorMessage();
        const name = document.getElementsByName('name')[0].value.trim();
        const description = document.getElementById('description').value.trim();
        isValid = true;

        if(name === ''){
            displayErrorMessage("name-error","Please enter a name");
            isValid = false;
        }else if(!/^[a-zA-Z\s]+$./test(name)){
            displayErrorMessage("name-error","Category name should be contain only alphabetic charaters");
            isValid = false;
        }

        if(description===''){
            displayErrorMessage("description-error","Please enter a description");
            isValid = false;
        }
        return isValid;

    }

    function displayErrorMessage(elementId,message){
        var errorElement = document.getElementById('elementId');
        errorElement.innerText = message;
        errorElement.style.display = "block"
    }

    function clearErrorMessages(){
        const errorElement = document.getElementsByClassName("error-message");
        Array.from(errorElement).forEach((elements)=>{
            elements.innerText = "";
            elements.style.display = 'none'
        })
    }
    
</script>