<%- include('../partials/admin/admin-header.ejs') -%>

<section class="content-main">
    <div class="content-header">
        <h2 class="content-title card-title">Order List</h2>
    </div>
    <div class="card mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (orders.length > 0) { %>
                            <% orders.forEach((order) => { %>
                                <tr>
                                    <td><%= order._id %></td>
                                    <td><b><%= order.userId.name %></b></td>
                                    <td><%= order.userId.email %></td>
                                    <td>$<%= order.totalAmount.toFixed(2) %></td>
                                    <!-- Status Dropdown in the Order List Table -->
                                        <td>
                                            <form action="/admin/orders/update-order-status/<%= order._id %>?page=<%= currentPage %>" method="POST">
                                                <select name="status" id="statusSelect-<%= order._id %>" class="form-select" onchange="updateOrderStatus('<%= order._id %>')">
                                                    <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                                    <option value="Completed" <%= order.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                                                    <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                                </select>
                                            </form>
                                        </td>

                                    <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                                    <td class="text-end">
                                        <% if (order.status === 'Cancelled') { %>
                                            <span class="badge bg-danger">Cancelled</span>
                                        <% } else if (order.status === 'Completed') { %>
                                            <span class="badge bg-success">Completed</span>
                                        <% } else if (order.status === 'Pending') { %>
                                            <span class="badge bg-warning">Pending</span>
                                        <% } %>

                                        <% if (order.status !== 'Cancelled') { %>
                                            <form action="/admin/orders/cancel/<%= order._id %>" method="POST" style="display:inline;">
                                                <button type="submit" class="btn btn-danger btn-sm">Cancel</button>
                                            </form>
                                        <% } else { %>
                                            <span class="text-muted">Cancelled</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="text-center">No orders found</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>

                <!-- Pagination Controls -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <% if (currentPage > 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
                            </li>
                        <% } %>
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                            </li>
                        <% } %>
                        <% if (currentPage < totalPages) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</section>



<script>
   function updateOrderStatus(orderId) {
    const newStatus = document.getElementById(`statusSelect-${orderId}`).value;

    // Show SweetAlert confirmation if "Cancelled" is selected
    if (newStatus === 'Cancelled') {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will cancel the order.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // If confirmed, send the request to update the status to 'Cancelled'
                fetch(`/admin/orders/update-order-status/${orderId}?page=${currentPage}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                })
                .then(response => response.json())  // Parse the JSON response
                .then(data => {
                    if (data.success && data.redirect) {
                        // Redirect to the same page if the update was successful and status is 'Cancelled'
                        Swal.fire('Cancelled', 'Order has been cancelled.', 'success').then(() => {
                            window.location.href = data.redirect;
                        });
                    } else {
                        Swal.fire('Error', 'Failed to cancel the order.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error cancelling order:', error);
                    Swal.fire('Error', 'An error occurred while cancelling the order.', 'error');
                });
            } else {
                // If the admin cancels the confirmation, reset the dropdown to the previous value
                document.getElementById(`statusSelect-${orderId}`).value = 'Pending';
            }
        });
    } else {
        // For other statuses, update directly without SweetAlert confirmation
        fetch(`/admin/orders/update-order-status/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Success', 'Order status updated successfully.', 'success');
            } else {
                Swal.fire('Error', 'Failed to update order status.', 'error');
            }
        })
        .catch(error => {
            console.error('Error updating status:', error);
            Swal.fire('Error', 'An error occurred while updating status.', 'error');
        });
    }
}



</script>



<%- include('../partials/admin/admin-footer.ejs') -%>